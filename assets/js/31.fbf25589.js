(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{486:function(s,t,n){"use strict";n.r(t);var a=n(2),e=Object(a.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h3",{attrs:{id:"前言"}},[s._v("前言")]),s._v(" "),n("p",[s._v("其实使用 "),n("code",[s._v("vite")]),s._v(" 已经有一段时间了，整体来说开发体验贼棒，陆续也踩过一些坑，最近又踩了一个 "),n("code",[s._v("enum")]),s._v(" 的坑，遂记录一下")]),s._v(" "),n("h3",{attrs:{id:"_1-alias"}},[s._v("1. alias")]),s._v(" "),n("p",[s._v("路径："),n("code",[s._v("vite.config.ts -> resolve -> alias")])]),s._v(" "),n("p",[n("code",[s._v("webpack")]),s._v(" 中我们经常会把 "),n("code",[s._v("@")]),s._v(" 配置成 "),n("code",[s._v("src")]),s._v(" 的根路径：")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    resolve"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        alias"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'@'")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" path"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cwd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'src'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("但在 "),n("code",[s._v("vite")]),s._v(" 中配了之后会报错，因为 "),n("code",[s._v("@")]),s._v(" 会被视为一个包，所以需要配置成这样：")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code")]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"})]),n("p",[s._v("尤雨溪的原话如下：")]),s._v(" "),n("blockquote",[n("p",[s._v("You have to import as /@/xxx, it cannot start with @ because that's considered a package.")]),s._v(" "),n("p",[s._v("Note Vite is not a bundler - it's a dev server. Any request not starting with / or . is considered a module dependency > request. All other requests must be valid HTTP requests (start with / or .).")])]),s._v(" "),n("p",[s._v("详见这个 "),n("a",{attrs:{href:"https://github.com/vitejs/vite/issues/279",target:"_blank",rel:"noopener noreferrer"}},[s._v("issue"),n("OutboundLink")],1)]),s._v(" "),n("h3",{attrs:{id:"_2-eslint"}},[s._v("2. eslint")]),s._v(" "),n("p",[n("code",[s._v("eslint")]),s._v(" 试过 两个插件："),n("code",[s._v("vite-plugin-style-import")]),s._v("、"),n("code",[s._v("@rollup/plugin-eslint")]),s._v("，发现还是后者好用，最终配置如下：")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    plugins"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("eslintPlugin")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            include"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'src/**/*.+(js|jsx|ts|tsx)'")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        enforce"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'pre'")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("h3",{attrs:{id:"_3-styleimport"}},[s._v("3. styleImport")]),s._v(" "),n("p",[s._v("想要动态导入样式，就需要这个 "),n("code",[s._v("vite-plugin-style-import")]),s._v(" 插件了，但实际使用时发现有两个问题：")]),s._v(" "),n("ul",[n("li",[s._v("会有额外的重复样式代码")]),s._v(" "),n("li",[s._v("如果用了自定义主题，某些样式仍然是原始主题色，比如 "),n("code",[s._v("a")]),s._v(" 标签")])]),s._v(" "),n("p",[n("code",[s._v("vite-plugin-style-import")]),s._v(" 的核心代码就是定位到 "),n("code",[s._v("style")]),s._v(" 位置，追加 "),n("code",[s._v("import")]),s._v(" 代码：")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" importCssStrList "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("transformComponentCss")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("root"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" lib"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" importVariables"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//...")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// transformComponetCss 里面再用 resolveNodeModules 拼接完整路径")]),s._v("\nimportStr "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("resolveNodeModules")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("root"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" importStr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("看不出来为什么会有上面这样的现象，所以暂时不管了，"),n("a",{attrs:{href:"https://github.com/anncwb/vite-plugin-style-import/issues/17",target:"_blank",rel:"noopener noreferrer"}},[s._v("issue"),n("OutboundLink")],1)]),s._v(" "),n("h3",{attrs:{id:"_4-d-ts、enum"}},[s._v("4. d.ts、enum")]),s._v(" "),n("p",[s._v("前两天突然发现有个页面挂了，而且 "),n("code",[s._v("vite")]),s._v(" 在 "),n("code",[s._v("console")]),s._v(" 里面的日志只显示模块加载失败，具体原因不知道。。\n最终发现是在一个 "),n("code",[s._v("d.ts")]),s._v(" 中定义了一个 "),n("code",[s._v("enum")]),s._v(" ，并且被一个层级深的 "),n("code",[s._v("tsx")]),s._v(" 文件引用了：")]),s._v(" "),n("blockquote",[n("p",[s._v("如果是最外面import, vite会直接有overlay提示，正是因为没有提示才让人懵逼")])]),s._v(" "),n("div",{staticClass:"language-ts line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-ts"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" SomeEnum "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'xxx'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("这个代码 "),n("code",[s._v("ts")]),s._v(" 并不会报错，能识别到是类型定义文件，但被页面引用后，生成的代码对应的就是会尝试加载 xxx\n而在 "),n("a",{attrs:{href:"https://sourcegraph.com/github.com/vitejs/vite/-/blob/packages/vite/src/node/constants.ts#L9:14",target:"_blank",rel:"noopener noreferrer"}},[s._v("源码"),n("OutboundLink")],1),s._v(" 中，默认只对这些后缀尝试匹配：")]),s._v(" "),n("div",{staticClass:"language-ts line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-ts"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("DEFAULT_EXTENSIONS")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.mjs'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.js'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.ts'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.jsx'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.tsx'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.json'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("综上所述，结果就是无法定位到文件，无论在开发(esbuild)还是生产(rollup)构建中，均会报错失败。")]),s._v(" "),n("blockquote",[n("p",[s._v("如果补全，加上 "),n("code",[s._v("xxx.d")]),s._v(" ，就可以运行了。。但不推荐\n因为在 typescript 中，d.ts 本来就不会有编译输出，就算你打全 "),n("code",[s._v("xxx.d")]),s._v("，也不会有的")])]),s._v(" "),n("p",[s._v("所以不要在 "),n("code",[s._v("d.ts")]),s._v(" 中定义 "),n("code",[s._v("enum")]),s._v("，而是应该把所有的 "),n("code",[s._v("enum")]),s._v(" 定义到一个 "),n("code",[s._v("ts")]),s._v(" 文件。")])])}),[],!1,null,null,null);t.default=e.exports}}]);